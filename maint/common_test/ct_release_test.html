<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <title>ct_release_test (common_test) -  (Erlang Documentation)</title>
    <link href="../erldocs.css" type="text/css" rel="stylesheet"/>
    <link href="/search.xml" rel="search" type="application/opensearchdescription+xml" title="erldocs"/>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-44246018-1', 'auto');
      ga('send', 'pageview');
    </script>
  </head>

  <body>
    <div id="sidebar" class="inactive">
      <input type="text" id="search" autocomplete="off" placeholder="press TAB to search"/>
      <ul id="results"> </ul>
    </div>

    <div id="content">
      <div style="margin:0px; padding:10px 20px;">
        

<h1>ct_release_test</h1>
<h2 class="modsummary">EXPERIMENTAL support for testing of upgrade.</h2>
<div class="description">
<p>EXPERIMENTAL support for testing of upgrade.</p>
 
  <p>This is a library module containing support for test of release  
related activities in one or more applications. Currenty it  
supports upgrade only.</p>
 
  <p><em><marker id="Configuration">Configuration</marker></em></p>
 
  <p>In order to find version numbers of applications to upgrade from,
  <code>ct_release_test</code> needs to access and start old OTP
  releases. A <code>common_test</code> configuration file can be used for  
specifying the location of such releases, for example:</p>
 
  <pre class="sh_erlang">  %% old-rels.cfg
  {otp_releases,[{r16b,"/path/to/R16B03-1/bin/erl"},
  	       {'17',"/path/to/17.3/bin/erl"}]}.</pre>
 
  <p>The configuration file should preferably point out the latest patch  
level on each major release.</p>
 
  <p>If no such configuration file is given, <a href="#init/1" class="seealso">init/1</a> will return
  <code>{skip,Reason}</code> and any attempt at running <a href="#upgrade/4" class="seealso">upgrade/4</a>  
will fail.</p>
 
  <p><em><marker id="Callback_functions">Callback functions</marker></em></p>
 
  <p>The following functions should be exported from a ct_release_test  
callback module.</p>
 
  <p>All callback functions are called on the node where the upgrade is  
executed.</p>
 
  <taglist>
    <dt>Module:upgrade_init(CtData,State) -&gt; NewState</dt>
    <item><p>Types:</p>
 
      <p><em>CtData = ct_data()</em><br />
      <em>State = NewState = cb_state()</em></p>
 
      <p>Initialyze system before upgrade test starts.</p>
 
      <p>This function is called before the upgrade is started. All
      applications given in <a href="#upgrade/4" class="seealso">upgrade/4</a> are already started by      
the boot script, so this callback is intended for additional      
initialization, if necessary.</p>
 
      <p><code>CtData</code> is an opaque data structure which shall be used
      in any call to <code>ct_release_test</code> inside the callback.</p>
 
      <p>Example:</p>
 
  <pre class="sh_erlang">  upgrade_init(CtData,State) -&gt;
      {ok,{FromVsn,ToVsn}} = ct_release_test:get_app_vsns(CtData,myapp),
      open_connection(State).</pre><p>
    </p></item>
 
    <dt>Module:upgrade_upgraded(CtData,State) -&gt; NewState</dt>
    <item><p>Types:</p>
 
      <p><em>CtData = ct_data()</em><br />
      <em>State = NewState = cb_state()</em></p>
 
      <p>Check that upgrade was successful.</p>
 
      <p>This function is called after the release_handler has      
successfully unpacked and installed the new release, and it has      
been made permanent. It allows application specific checks to      
ensure that the upgrade was successful.</p>
 
      <p><code>CtData</code> is an opaque data structure which shall be used
      in any call to <code>ct_release_test</code> inside the callback.</p>
 
      <p>Example:</p>
 
  <pre class="sh_erlang">  upgrade_upgraded(CtData,State) -&gt;
      check_connection_still_open(State).</pre><p>
    </p></item>
 
    <dt>Module:upgrade_downgraded(CtData,State) -&gt; NewState</dt>
    <item><p>Types:</p>
 
      <p><em>CtData = ct_data()</em><br />
      <em>State = NewState = cb_state()</em></p>
 
      <p>Check that downgrade was successful.</p>
 
      <p>This function is called after the release_handler has      
successfully re-installed the original release, and it has been      
made permanent. It allows application specific checks to ensure      
that the downgrade was successful.</p>
 
      <p><code>CtData</code> is an opaque data structure which shall be used
      in any call to <code>ct_release_test</code> inside the callback.</p>
 
      <p>Example:</p>
 
  <pre class="sh_erlang">  upgrade_downgraded(CtData,State) -&gt;
      check_connection_closed(State).</pre><p>
    </p></item>
  </taglist></div>
<div id="types" class="category"><h4><a href="#types">Types</a></h4><hr />
    <div class="type"><h3 id="type-cb_state">cb_state() = term()</h3></div>
    <div class="type"><h3 id="type-config">config() = [{atom(), term()}]</h3></div>
    <div class="type"><h3 id="type-ct_data">ct_data()</h3></div></div>
<div id="functions" class="category"><h4><a href="#functions">Functions</a></h4><hr />
<div class="function">
<h3 id="init/1">init(Config) -&gt; Result</h3>

<ul class="type">
<li><code>Config = config()</code></li><li><code>Result = config() | SkipOrFail</code></li><li><code>SkipOrFail = {skip, Reason} | {fail, Reason}</code></li></ul>
<div class="description">

<p>Initialize <code>ct_release_test</code>.</p>
 
  <p>This function can be called from any of the
  <code>init_per_*</code> functions in the test suite. It updates
  the given <code>Config</code> with data that will be
  used by future calls to other functions in this module. The
  returned configuration must therefore also be returned from
  the calling <code>init_per_*</code>.</p>
 
  <p>If the initialization fails, e.g. if a required release can
  not be found, the function returns <code>{skip,Reason}</code>. In  
this case the other test support functions in this mudule  
can not be used.</p>
 
  <p>Example:</p>
 
  <pre class="sh_erlang">  init_per_suite(Config) -&gt;
      ct_release_test:init(Config).</pre><p>
 </p>
</div></div>
<div class="function">
<h3 id="upgrade/4">upgrade(App, Level, Callback, Config) -&gt; any()</h3>

<ul class="type">
<li><code>App = atom()</code></li><li><code>Level = minor | major</code></li><li><code>Callback = {module(), InitState}</code></li><li><code>InitState = cb_state()</code></li><li><code>Config = config()</code></li></ul>
<div class="description">

<p>Test upgrade of the given application(s).</p>
 
  <p>This function can be called from a test case. It requires that
  <code>Config</code> has been initialized by calling <a href="#init/1" class="seealso">init/1</a> prior to this, for example from <code>init_per_suite/1</code>.</p>
 
  <p>Upgrade tests are performed as follows:</p>
 
  <list>
    <item>Figure out which OTP release to test upgrade
      from. Start a node running that release and find the
      application versions on that node. Terminate the
      node.</item>
    <item>Figure out all dependencies for the applications under
      test.</item>
    <item>Create a release containing the core
      applications <code>kernel</code>, <code>stdlib</code> and <code>sasl</code>
      in addition to the application(s) under test and all
      dependencies of these. The versions of the applications
      under test will be the ones found on the OTP release to
      upgrade from. The versions of all other applications will
      be those found on the current node, i.e. the common_test
      node. This is the "From"-release.</item>
    <item>Create another release containing the same
      applications as in the previous step, but with all
      application versions taken from the current node. This is
      the "To"-release.</item>
    <item>Install the "From"-release and start a new node
      running this release.</item>
    <item>Perform the upgrade test and allow customized
      control by using callbacks:
      <list>
        <item>Callback: <code>upgrade_init/2</code></item>
        <item>Unpack the new release</item>
        <item>Install the new release</item>
        <item>Callback: <code>upgrade_upgraded/2</code></item>
        <item>Install the original release</item>
        <item>Callback: <code>upgrade_downgraded/2</code></item>
      </list>
    </item>
  </list>
 
  <p><code>App</code> or <code>Apps</code>  
specifies the applications under test, i.e. the applications  
which shall be upgraded. All other applications that are  
included have the same releases in the "From"- and  
"To"-releases and will therefore not be upgraded.</p>
 
  <p><code>Level</code> specifies which OTP release to
  pick the "From" versions from.
  </p><taglist>
    <dt>major</dt>
    <item><p>From verions are picked from the previous major
      release. For example, if the test is run on an OTP-17
      node, <code>ct_release_test</code> will pick the application
      "From" versions from an OTP installation running OTP
      R16B.</p></item>
 
    <dt>minor</dt>
    <item><p>From verions are picked from the current major
      release. For example, if the test is run on an OTP-17
      node, <code>ct_release_test</code> will pick the application
      "From" versions from an OTP installation running an
      earlier patch level of OTP-17.</p></item>
  </taglist>
 
  <p>The application "To" versions are allways picked from the  
current node, i.e. the common_test node.</p>
 
  <p><code>Callback</code> specifies the module (normally the
  test suite) which implements the <a href="#Callback_functions" class="seealso">Callback functions</a>, and
  the initial value of the <code>State</code> variable used in these  
functions.</p>
 
  <p><code>Config</code> is the input argument received  
in the test case function.</p>
 
  <p>Example:</p>
 
  <pre class="sh_erlang">  minor_upgrade(Config) -&gt;
      ct_release_test:upgrade(ssl,minor,{?MODULE,[]},Config).</pre><p>
 </p>
</div></div>
<div class="function">
<h3 id="cleanup/1">cleanup(Config) -&gt; Result</h3>

<ul class="type">
<li><code>Config = config()</code></li><li><code>Result = config()</code></li></ul>
<div class="description">

<p>Clean up after tests.</p>
 
  <p>This function shall be called from the <code>end_per_*</code> function
  complementing the <code>init_per_*</code> function where <a href="#init/1" class="seealso">init/1</a>  
is called.</p>
 
  <p>It cleans up after the test, for example kills hanging  
nodes.</p>
 
  <p>Example:</p>
 
  <pre class="sh_erlang">  end_per_suite(Config) -&gt;
      ct_release_test:cleanup(Config).</pre><p>
 </p>
</div></div>
<div class="function">
<h3 id="get_app_vsns/2">get_app_vsns(CtData, App) -&gt; {ok, {From, To}} | {error, Reason}</h3>

<ul class="type">
<li><code>CtData = ct_data()</code></li><li><code>App = atom()</code></li><li><code>From = string()</code></li><li><code>To = string()</code></li><li><code>Reason = {app_not_found, App}</code></li></ul>
<div class="description">

<p>Get versions involved in this upgrade for the given application.</p>
 
  <p>This function can be called from inside any of the callback  
functions. It returns the old (From) and new (To) versions involved  
in the upgrade/downgrade test for the given application.</p>
 
  <p><code>CtData</code> must be the first argument received in the
  calling callback function - an opaque data structure set by
  <code>ct_release_tests</code>.</p>
</div></div>
<div class="function">
<h3 id="get_appup/2">get_appup(CtData, App) -&gt; {ok, Appup} | {error, Reason}</h3>

<ul class="type">
<li><code>CtData = ct_data()</code></li><li><code>App = atom()</code></li><li><code>Appup = {From, To, Up, Down}</code></li><li><code>From = string()</code></li><li><code>To = string()</code></li><li><code>Up = [Instr]</code></li><li><code>Down = [Instr]</code></li><li><code>Instr = term()</code></li><li><code>Reason = {app_not_found, App} | {vsn_not_found, {App, From}}</code></li></ul>
<div class="description">

<p>Get appup instructions for the given application.</p>
 
  <p>This function can be called from inside any of the callback  
functions. It reads the appup file for the given application and  
returns the instructions for upgrade and downgrade for the versions  
in the test.</p>
 
  <p><code>CtData</code> must be the first argument received in the
  calling callback function - an opaque data structure set by
  <code>ct_release_tests</code>.</p>
 
  <p>See reference manual for appup files for types definitions for the
  instructions.</p>
</div></div></div>

<authors>
<aname> </aname>
<email> </email></authors>
      </div>
  </div>

    <script type="text/javascript">
      var CURRENT_ROOT = "../";
    </script>

    <script type="text/javascript" src="../jquery.js"></script>
    <script type="text/javascript" src="../erldocs_index.js"></script>
    <script type="text/javascript" src="../erldocs.js"></script>
  </body>
</html>
